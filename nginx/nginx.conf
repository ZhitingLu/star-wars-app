# Basic events block required by nginx, usually left empty for simple setups
events {}

http {
    # Define backend upstream group: this points to the Python backend service running on port 8000
    upstream backend {
        server starwars-backend:8000;
    }

    # Define frontend upstream group: this points to the Next.js frontend server running on port 3000
    upstream frontend {
        server starwars-frontend:3000;
    }

    server {
        # Listen on port 80 inside the container (nginx default HTTP port)
        listen 80;

        # Proxy API requests starting with /api/ to the backend service
        location /api/ {
            # Forward the request to the backend upstream group defined above
            proxy_pass http://backend/;

             # Timeouts
            proxy_read_timeout 60s;
            proxy_connect_timeout 60s;

            # Preserve the original Host header from client
            proxy_set_header Host $host;

            # Pass the client's real IP address for logging/tracking in backend
            proxy_set_header X-Real-IP $remote_addr;

            # Forward client IP chain if there are proxies/load balancers in front
            proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;

            # Forward the original protocol (http/https)
            proxy_set_header X-Forwarded-Proto $scheme;
        }

                # Proxy requests for the FastAPI Swagger UI docs page
        location /docs {
            # Forward /docs/ requests to the backend service's /docs/ endpoint
            proxy_pass http://backend/docs;

            # Preserve the original Host header (useful for backend logging, routing)
            proxy_set_header Host $host;

            # Forward the real client IP address to the backend (for logging, rate limiting, etc.)
            proxy_set_header X-Real-IP $remote_addr;

            # Pass the full client IP chain through proxies/load balancers
            proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;

            # Forward the original protocol (http or https)
            proxy_set_header X-Forwarded-Proto $scheme;
        }

        # Proxy request for the OpenAPI JSON schema file used by Swagger and other tools
        location /openapi.json {
            # Forward /openapi.json requests to backend's OpenAPI JSON endpoint
            proxy_pass http://backend/openapi.json;

            # Same headers as above to preserve client and protocol info
            proxy_set_header Host $host;
            proxy_set_header X-Real-IP $remote_addr;
            proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
            proxy_set_header X-Forwarded-Proto $scheme;
        }

        # Proxy requests for the ReDoc UI documentation page (alternative to Swagger UI)
        location /redoc {
            # Forward /redoc/ requests to backend's ReDoc endpoint
            proxy_pass http://backend/redoc;

            # Preserve client and protocol info headers
            proxy_set_header Host $host;
            proxy_set_header X-Real-IP $remote_addr;
            proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
            proxy_set_header X-Forwarded-Proto $scheme;
        }


        # Proxy all other requests to the Next.js frontend server (handles SSR and static files)
        location / {
            # Forward request to frontend upstream
            proxy_pass http://frontend/;

             # Timeouts
            proxy_read_timeout 60s;
            proxy_connect_timeout 60s;

            # Use HTTP/1.1 for proper WebSocket and connection upgrades
            proxy_http_version 1.1;

            # Support WebSocket upgrade headers (needed for live reload, etc.)
            proxy_set_header Upgrade $http_upgrade;

            # Maintain connection upgrade header for WebSocket
            proxy_set_header Connection "upgrade";

            # Preserve original Host header
            proxy_set_header Host $host;

            # Forward real client IP
            proxy_set_header X-Real-IP $remote_addr;

            # Forward proxy chain of IPs
            proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;

            # Forward original protocol
            proxy_set_header X-Forwarded-Proto $scheme;
        }
    }
}
